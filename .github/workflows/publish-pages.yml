name: Publish SPX Reports to GitHub Pages

on:
  workflow_run:
    workflows: ["SPX Research Scheduled"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install markdown jinja2

      - name: Determine Run ID
        id: get_run_id
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # If triggered by workflow_run, use that ID
          if [ "${{ github.event.workflow_run.id }}" != "" ]; then
            echo "run_id=${{ github.event.workflow_run.id }}" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # If manual dispatch, find the latest successful run of the research workflow
          echo "Finding latest successful run of 'SPX Research Scheduled'..."
          LATEST_RUN_ID=$(gh run list --workflow "spx-research-scheduled.yml" --status success --limit 1 --json databaseId --jq '.[0].databaseId')
          
          if [ -z "$LATEST_RUN_ID" ] || [ "$LATEST_RUN_ID" == "null" ]; then
            echo "Error: No successful run found to publish."
            exit 1
          fi

          echo "Found latest run_id: $LATEST_RUN_ID"
          echo "run_id=$LATEST_RUN_ID" >> "$GITHUB_OUTPUT"

      - name: Download research artifacts
        uses: actions/download-artifact@v4
        with:
          path: _artifacts
          run-id: ${{ steps.get_run_id.outputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build static site
        shell: bash
        run: |
          set -e

          mkdir -p site
          mkdir -p site/reports
          mkdir -p site/json

          # 1) 收集所有 reports/*.md 与 json/*.json
          # artifacts 结构类似：_artifacts/<artifact-name>/outputs/...
          find _artifacts -type f -path "*/outputs/reports/*.md" -print0 | while IFS= read -r -d '' f; do
            cp "$f" site/reports/
          done

          find _artifacts -type f -path "*/outputs/json/*.json" -print0 | while IFS= read -r -d '' f; do
            cp "$f" site/json/
          done

          # 2) 生成 index.html（报告列表页）
          python - <<'PY'
          import os, glob, datetime
          from pathlib import Path
          import markdown

          site = Path("site")
          reports = sorted(glob.glob("site/reports/*.md"), reverse=True)

          # 生成单页 HTML（把 md 转成 html），每个报告一个 html
          for md_path in reports:
            p = Path(md_path)
            name = p.stem
            html = markdown.markdown(p.read_text(encoding="utf-8"), extensions=["tables", "fenced_code"])
            out = site / "reports" / f"{name}.html"
            out.write_text(
              f"""<!doctype html>
              <html><head>
                <meta charset="utf-8"/>
                <meta name="viewport" content="width=device-width, initial-scale=1"/>
                <title>{name}</title>
                <style>
                  body {{ font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin: 2rem; max-width: 980px; }}
                  pre {{ overflow:auto; padding: 1rem; background:#f6f8fa; }}
                  code {{ background:#f6f8fa; padding: .1rem .2rem; }}
                  table {{ border-collapse: collapse; }}
                  th, td {{ border: 1px solid #ddd; padding: .5rem; }}
                  a {{ text-decoration: none; }}
                </style>
              </head><body>
                <p><a href="../index.html">← Back</a></p>
                {html}
              </body></html>""",
              encoding="utf-8",
            )

          # index 页
          items = []
          for md_path in reports:
            p = Path(md_path)
            name = p.stem
            items.append(f'<li><a href="reports/{name}.html">{name}</a> '
                         f'&nbsp;|&nbsp; <a href="reports/{name}.md">md</a> '
                         f'&nbsp;|&nbsp; <a href="json/{name}.json">json</a></li>')

          now = datetime.datetime.utcnow().strftime("%Y-%m-%d %H:%M UTC")
          index = f"""<!doctype html>
          <html><head>
            <meta charset="utf-8"/>
            <meta name="viewport" content="width=device-width, initial-scale=1"/>
            <title>SPX Research Reports</title>
            <style>
              body {{ font-family: -apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial; margin: 2rem; max-width: 980px; }}
              li {{ margin: .4rem 0; }}
            </style>
          </head><body>
            <h1>SPX Research Reports</h1>
            <p>Updated: {now}</p>
            <ul>
              {''.join(items) if items else '<li>No reports found yet.</li>'}
            </ul>
          </body></html>
          """
          (site/"index.html").write_text(index, encoding="utf-8")
          PY

          # 3) 把 md 原文也复制到 site/reports（供下载）
          cp -f site/reports/*.md site/reports/ 2>/dev/null || true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
